name: Deploy Docker

on:
  workflow_dispatch:  # Zaženeš ročno prek GitHub Actions UI

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Kloniraj repozitorij
        uses: actions/checkout@v4

      # Prenesi vse status artefakte, ki so bili ustvarjeni v 28563_test.yml
      - name: Prenesi status-3.1
        uses: actions/download-artifact@v4
        with:
          name: status-3.1
          path: ./status-3.1

      - name: Prenesi status-3.11
        uses: actions/download-artifact@v4
        with:
          name: status-3.11
          path: ./status-3.11

      # Preveri vsebino status.txt datotek (če so testi uspeli)
      - name: Preveri vsebino vseh status.txt
        run: |
          echo "Preverjam vse statuse..."
          ok1=$(cat ./status-3.1/status.txt 2>/dev/null || echo "")
          ok2=$(cat ./status-3.11/status.txt 2>/dev/null || echo "")

          if [[ "$ok1" == "ok" && "$ok2" == "ok" ]]; then
            echo "✅ Vsi testi so bili uspešni – nadaljujem z deployem."
          else
            echo "❌ Eden ali več testov ni uspelo – prekinjam deploy."
            exit 1
          fi

      # Prijava v DockerHub – geslo in uporabniško ime morata biti shranjena kot GitHub Secrets
      - name: Prijava v DockerHub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # Zgradi Docker image iz Dockerfile
      - name: Zgradi Docker image
        run: docker build -t gaspermelansek/uvodvopencv .

      # Potisni image na DockerHub
      - name: Push Docker image
        run: docker push gaspermelansek/uvodvopencv
